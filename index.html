<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Neon Orbit ‚Äî Level Mini Game</title>

<style>
  :root{
    --bg:#090a16; --card:#0f1226; --ring:#2a2e58;
    --ink:#eef4ff; --mut:#9fb0d9; --g1:#ff6ec4; --g2:#7873f5; --a3:#78f3ff; --ok:#aef7c1; --bad:#ffb3be;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:radial-gradient(1100px 700px at 20% -10%, #101435 0%, #090a16 55%, #060812 100%);
    color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; overflow:hidden;
  }
  #game-root{position:fixed; inset:0}
  /* HUD */
  .hud{
    position:fixed; left:0; right:0; top:0; display:flex; gap:8px; padding:10px; pointer-events:none;
  }
  .chip{
    background:rgba(12,18,48,.75); border:1px solid #223; border-radius:12px; padding:8px 10px; pointer-events:auto;
    display:flex; align-items:center; gap:8px; backdrop-filter: blur(8px);
  }
  .chip b{font-size:14px}
  .bar{height:10px; border-radius:999px; background:#0c1130; border:1px solid #223; overflow:hidden; width:180px}
  .bar>i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--g1),var(--g2)); transition:width .2s}
  /* Overlay */
  .overlay{
    position:fixed; inset:0; display:grid; place-items:center; background:linear-gradient(180deg,rgba(10,7,24,.6),rgba(9,10,22,.9));
  }
  .panel{
    width:min(540px,92%); background:var(--card); border:1px solid var(--ring); border-radius:18px; padding:22px;
    box-shadow:0 0 60px rgba(120,115,245,.25), inset 0 0 0 1px rgba(255,255,255,.02);
  }
  h1{margin:0 0 6px; font-size:22px}
  .mut{color:var(--mut)}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .btn{
    padding:12px 14px; background:#10163b; color:var(--ink); border:1px solid #2a2e58; border-radius:12px; cursor:pointer; font-weight:700;
  }
  .btn[disabled]{opacity:.5; cursor:not-allowed}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
  .note{font-size:12px; color:var(--mut); margin-top:8px}
  .ok{color:var(--ok)} .bad{color:var(--bad)}
  .footer{
    position:fixed; bottom:8px; left:0; right:0; text-align:center; color:#9fb0d9; font-size:11px; pointer-events:none;
  }
</style>
</head>
<body>
<div id="game-root"></div>

<!-- HUD -->
<div class="hud" id="hud">
  <div class="chip"><span>Level</span><b id="hudLevel">1</b></div>
  <div class="chip"><span>XP</span>
    <div class="bar"><i id="xpBar"></i></div>
  </div>
  <div class="chip"><span>Coins</span><b id="hudCoins">0</b></div>
  <div class="chip"><span>Lives</span><b id="hudLives">3</b></div>
</div>

<!-- Overlay Panels -->
<div class="overlay" id="overlay">
  <div class="panel">
    <h1 id="ovTitle">Neon Orbit</h1>
    <p class="mut" id="ovText">Drag or tap to move. Collect <b>orbs</b>, avoid <b>hazards</b>. Beat the goal to clear the level.</p>

    <div class="grid">
      <button class="btn" id="btnStart">‚ñ∂ Start</button>
      <button class="btn" id="btnResume" style="display:none">‚èØ Resume</button>

      <button class="btn" id="btnUpgradeSpeed">‚ö° Speed +1<br><span class="note" id="speedCost">Cost: 20</span></button>
      <button class="btn" id="btnUpgradeMagnet">üß≤ Magnet +10%<br><span class="note" id="magCost">Cost: 25</span></button>

      <button class="btn" id="btnNext" style="display:none">‚û° Next Level</button>
      <button class="btn" id="btnRestart" style="display:none">‚Üª Restart</button>
    </div>

    <div class="note" id="ovNote"></div>
  </div>
</div>

<div class="footer">Neon Orbit ‚Äî demo build</div>

<!-- Phaser -->
<script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.js"></script>
<script>
/* =======================
   Minimal ‚Äúadvanced‚Äù level game in one file
   ======================= */

const SAVE_KEY = 'neon_orbit_progress_v1';
const W = window.innerWidth, H = window.innerHeight;

// --- Save / Load ---
const Save = {
  data: { level:1, xp:0, coins:0, lives:3, speed:200, magnet:0.0, best:0 },
  load(){
    try{
      const raw = localStorage.getItem(SAVE_KEY);
      if(raw){ Object.assign(this.data, JSON.parse(raw)||{}); }
    }catch(e){}
  },
  save(){ localStorage.setItem(SAVE_KEY, JSON.stringify(this.data)); }
};
Save.load();

// --- Level config ---
const Levels = [
  { goal:12, time:45, hazards:3, spawn:1.0, enemySpeed:90 },
  { goal:18, time:50, hazards:4, spawn:0.9, enemySpeed:110 },
  { goal:25, time:55, hazards:5, spawn:0.8, enemySpeed:130 },
  { goal:32, time:60, hazards:6, spawn:0.7, enemySpeed:150 },
  { goal:42, time:65, hazards:7, spawn:0.6, enemySpeed:170 },
];

function xpNeeded(level){ return 50 + (level-1)*50; }
function fmt(n){ return Math.floor(n); }

// --- UI refs ---
const hudLevel = document.getElementById('hudLevel');
const xpBar = document.getElementById('xpBar');
const hudCoins = document.getElementById('hudCoins');
const hudLives = document.getElementById('hudLives');
const overlay = document.getElementById('overlay');
const ovTitle = document.getElementById('ovTitle');
const ovText = document.getElementById('ovText');
const ovNote = document.getElementById('ovNote');
const btnStart = document.getElementById('btnStart');
const btnResume = document.getElementById('btnResume');
const btnNext = document.getElementById('btnNext');
const btnRestart = document.getElementById('btnRestart');
const btnUS = document.getElementById('btnUpgradeSpeed');
const btnUM = document.getElementById('btnUpgradeMagnet');
const speedCostEl = document.getElementById('speedCost');
const magCostEl = document.getElementById('magCost');

function upgradeCosts(){
  const spdLvl = (Save.data.speed-200)/50; // 0,1,2...
  const magLvl = Math.round(Save.data.magnet*10); // 0..?
  return { speed: 20 + spdLvl*20, magnet: 25 + magLvl*25 };
}

function refreshHUD(){
  hudLevel.textContent = Save.data.level;
  hudCoins.textContent = fmt(Save.data.coins);
  hudLives.textContent = Save.data.lives;
  const need = xpNeeded(Save.data.level);
  xpBar.style.width = `${Math.min(100, (Save.data.xp/need)*100)}%`;
  const {speed, magnet} = upgradeCosts();
  speedCostEl.textContent = `Cost: ${speed}`;
  magCostEl.textContent = `Cost: ${magnet}`;
}
refreshHUD();

// --- Phaser Game ---
class PlayScene extends Phaser.Scene{
  constructor(){ super('play'); }

  create(){
    const cw = this.scale.width, ch = this.scale.height;

    // Background stars
    this.add.particles(0,0,'white',
      { speed:10, lifespan:6000, quantity:1, scale:{start:.8,end:0}, alpha:.25, emitZone: { type:'random', source: new Phaser.Geom.Rectangle(0,0,cw,ch) } });

    // Player (vector circle)
    this.player = this.add.circle(cw*0.5, ch*0.5, 16, 0x78f3ff);
    this.physics.add.existing(this.player);
    this.player.body.setCircle(16).setCollideWorldBounds(true);
    this.playerSpeed = Save.data.speed;

    // Groups
    this.orbs = this.physics.add.group();
    this.haz = this.physics.add.group();

    // Timers
    const L = Levels[(Save.data.level-1) % Levels.length];
    this.goal = L.goal;
    this.left = L.time;
    this.collected = 0;
    this.hazardSpeed = L.enemySpeed;
    this.spawnTimer = this.time.addEvent({ delay: L.spawn*1000, loop:true, callback: ()=> this.spawnOrb() });
    for(let i=0;i<L.hazards;i++){ this.spawnHazard(); }

    // Texts
    this.info = this.add.text(12, ch-24, '', { font:'14px system-ui', fill:'#9fb0d9' }).setDepth(5);

    // Collisions
    this.physics.add.overlap(this.player, this.orbs, (_p, orb)=> this.collectOrb(orb));
    this.physics.add.overlap(this.player, this.haz, (_p, hz)=> this.hitHazard(hz));

    // Input (drag or pointer)
    this.input.on('pointerdown', p=> this.moveTo(p));
    this.input.on('pointermove', p=> { if(p.isDown) this.moveTo(p); });

    // Countdown
    this.timer = this.time.addEvent({ delay:1000, loop:true, callback:()=>{
      this.left--;
      if(this.left<=0){ this.levelEnd(false); }
    }});
  }

  moveTo(pointer){
    const v = new Phaser.Math.Vector2(pointer.x - this.player.x, pointer.y - this.player.y);
    v.normalize().scale(this.playerSpeed);
    this.player.body.setVelocity(v.x, v.y);
  }

  spawnOrb(){
    const x = Phaser.Math.Between(24, this.scale.width-24);
    const y = Phaser.Math.Between(24, this.scale.height-24);
    const orb = this.add.circle(x,y,10,0xff6ec4);
    this.orbs.add(orb);
    orb.body = this.physics.add.existing(orb).body;
    orb.body.setCircle(10).setImmovable(true);
    // drift
    orb.body.setVelocity(Phaser.Math.Between(-40,40), Phaser.Math.Between(-40,40)).setBounce(1,1).setCollideWorldBounds(true);
  }

  spawnHazard(){
    const pad=20;
    const x = Phaser.Math.Between(pad,this.scale.width-pad);
    const y = Phaser.Math.Between(pad,this.scale.height-pad);
    const hz = this.add.triangle(x,y, 0,18, 36,18, 18,0, 0xff596a);
    this.haz.add(hz);
    this.physics.add.existing(hz);
    hz.body.setVelocity(Phaser.Math.Between(-this.hazardSpeed,this.hazardSpeed), Phaser.Math.Between(-this.hazardSpeed,this.hazardSpeed))
      .setBounce(1,1).setCollideWorldBounds(true);
  }

  collectOrb(orb){
    orb.destroy();
    this.collected++;
    Save.data.coins += 1;
    Save.data.xp += 5;
    // particle pop
    const p = this.add.particles(orb.x, orb.y, 'white', { lifespan:400, speed:120, quantity:8, scale:{start:1,end:0}});
    this.time.delayedCall(400, ()=> p.destroy());
    if(this.collected >= this.goal){ this.levelEnd(true); }
  }

  hitHazard(hz){
    hz.body.velocity.scale(-1); // bounce back
    if(this._invuln) return;
    this._invuln = true;
    this.tweens.add({ targets:this.player, scale:0.8, yoyo:true, duration:80, repeat:3 });
    Save.data.lives -= 1;
    if(Save.data.lives <= 0){ this.levelEnd(false); }
    this.time.delayedCall(800, ()=> this._invuln = false);
  }

  applyMagnet(){
    const r = 48 + 160*Save.data.magnet; // grows with magnet %
    this.orbs.getChildren().forEach(o=>{
      const dx = this.player.x - o.x, dy = this.player.y - o.y;
      const d2 = dx*dx + dy*dy;
      if(d2 < r*r){
        const v = new Phaser.Math.Vector2(dx,dy).normalize().scale(160);
        o.body.velocity.x += v.x * this.game.loop.delta/1000;
        o.body.velocity.y += v.y * this.game.loop.delta/1000;
      }
    });
  }

  levelEnd(win){
    this.scene.pause();
    Save.save();
    showOverlay(win ? 'Level cleared!' : 'Level failed',
      win ? `You collected ${this.collected}/${this.goal}. +XP +Coins` :
            `Goal was ${this.goal}. Try again.`,
      { next:win, restart:true, resume:false }
    );
  }

  update(){
    this.applyMagnet();
    this.info.setText(`Goal ${this.collected}/${this.goal} ‚Ä¢ Time ${this.left}s`);
  }
}

// Boot + Phaser config
const game = new Phaser.Game({
  type: Phaser.AUTO,
  parent: 'game-root',
  width: W, height: H,
  backgroundColor: '#0a0718',
  physics: { default:'arcade', arcade:{ gravity:{y:0}, debug:false } },
  scale: { mode: Phaser.Scale.RESIZE, autoCenter: Phaser.Scale.CENTER_BOTH },
  scene: [PlayScene],
});

// Tiny 1px texture for particles (no external assets)
game.textures.once('onload', ()=>{
  const g = document.createElement('canvas'); g.width=g.height=2;
  const cx = g.getContext('2d'); cx.fillStyle='#fff'; cx.fillRect(0,0,2,2);
  game.textures.addBase64('white', g.toDataURL());
});

// --- Overlay control ---
function showOverlay(title, text, opts={}){
  ovTitle.textContent = title;
  ovText.innerHTML = text;
  btnStart.style.display = opts.start ? '' : 'none';
  btnResume.style.display = opts.resume ? '' : 'none';
  btnNext.style.display = opts.next ? '' : 'none';
  btnRestart.style.display = opts.restart ? '' : 'none';
  overlay.style.display = '';
  refreshHUD();
  const need = xpNeeded(Save.data.level);
  // Level up if enough XP
  while(Save.data.xp >= need){
    Save.data.xp -= need;
    Save.data.level++;
    Save.data.lives = Math.min(5, Save.data.lives+1);
  }
  Save.save();
}

function hideOverlay(){ overlay.style.display='none'; }

// Initial overlay
showOverlay('Neon Orbit', `Drag or tap to move.<br>Collect <b>orbs</b>, avoid <b>hazards</b>.<br>Beat the goal before time runs out.`,
            { start:true, resume:false, next:false, restart:false });

// Buttons
btnStart.onclick = ()=>{ hideOverlay(); startLevel(true); };
btnResume.onclick = ()=>{ hideOverlay(); game.scene.resume('play'); };
btnNext.onclick = ()=>{ Save.data.level++; Save.save(); hideOverlay(); startLevel(true); };
btnRestart.onclick = ()=>{ Save.data.lives = 3; Save.save(); hideOverlay(); startLevel(true); };

btnUS.onclick = ()=>{
  const cost = upgradeCosts().speed;
  if(Save.data.coins < cost){ ovNote.textContent = 'Not enough coins.'; return; }
  Save.data.coins -= cost;
  Save.data.speed += 50; // +50 px/s
  Save.save(); refreshHUD();
  ovNote.textContent = 'Speed upgraded!';
};
btnUM.onclick = ()=>{
  const cost = upgradeCosts().magnet;
  if(Save.data.coins < cost){ ovNote.textContent = 'Not enough coins.'; return; }
  Save.data.coins -= cost;
  Save.data.magnet = Math.min(.9, Save.data.magnet + 0.1); // +10%
  Save.save(); refreshHUD();
  ovNote.textContent = 'Magnet upgraded!';
};

function startLevel(resetLives){
  if(resetLives) Save.data.lives = Math.max(3, Save.data.lives);
  refreshHUD();
  const play = game.scene.getScene('play');
  if(play) game.scene.remove('play');
  game.scene.add('play', PlayScene, true);
}

// Pause when overlay is visible
document.addEventListener('visibilitychange', ()=>{
  const play = game.scene.getScene('play');
  if(document.hidden && play) { game.scene.pause('play'); btnResume.style.display=''; overlay.style.display=''; ovTitle.textContent='Paused'; ovText.textContent=''; btnStart.style.display='none'; btnNext.style.display='none'; btnRestart.style.display=''; }
});
</script>
</body>
</html>
